if("function"!=typeof define)var define=require("amdefine")(module);define(["./Kit","./parse"],function(t,e){function n(t,e){if(e=e||"normal",k[t]&&k[t][e])return k[t][e];y.attr({"font-size":t,"font-weight":e});var n=y.getBBox();return k[t]=k[t]||{},k[t][e]={width:n.width/((y.attr("text").length-1)/2),height:n.height/2}}function i(t){y=y||t.text(-1e3,-1e3,"XgfTlM|.q\nXgfTlM|.q").attr("font-family",v)}function r(t,e){e.clear(),i(e);var r=f(t.tree);r.unshift(d("RegExp:"));var s,o,u=n(m,"bold"),l=b,c=u.height/2+b;s=r.reduce(function(t,e){e.x=t,e.y=c;var n=e.text.length*u.width;return t+n},l),s+=b,o=u.height+2*b,r=e.add(r),e.setSize(s,u.height+2*b);var p=h(t.tree,0,0);o=Math.max(p.height+3*b+u.height,o),s=Math.max(p.width+2*b,s),e.setSize(s,o),a(p.items,b,2*b+u.height-p.y),e.add(p.items)}function h(t,e,n){return t.unshift({type:"startPoint"}),t.push({type:"endPoint"}),s(t,e,n)}function a(t,e,n){t.forEach(function(t){t._translate&&t._translate(e,n),t.x+=e,t.y+=n})}function s(t,e,n){var i=[],r=[],h=0,a=0,s=e,o=n,u=n;if(!t.length)return X.empty(null,e,n);t.forEach(function(t){var e;e=t.repeat?X.repeat(t,s,n):X[t.type](t,s,n),i.push(e),s+=e.width+x,h+=e.width,o=Math.min(o,e.y),u=Math.max(u,e.y+e.height),r=r.concat(e.items)}),a=u-o,i.reduce(function(t,e){h+=x;var i=l(t.lineOutX,n,e.lineInX);return r.push(i),e});var c=i[0].lineInX,p=i[i.length-1].lineOutX;return{items:r,width:h,height:a,x:e,y:o,lineInX:c,lineOutX:p}}function o(e,i,r,h,a){e=t.toPrint(e);var s=6,o=n(m),u=e.length*o.width,l=o.height+2*s,c=u+2*s,p={type:"rect",x:i,y:r-l/2,width:c,height:l,stroke:"none",fill:h||"transparent"},f={type:"text",x:i+c/2,y:r,text:e,"font-size":m,fill:a||"black"};return{text:f,rect:p,items:[p,f],width:c,height:l,x:i,y:p.y,lineInX:i,lineOutX:i+c}}function u(t,e,i,r){var h,a=n(w),s=i.split("\n"),o=s.length*a.height;h=s.length>1?Math.max.apply(Math,s.map(function(t){return t.length})):i.length,h*=a.width;var u=4,l={type:"text",x:t,y:e-o/2-u,text:i,"font-size":w,fill:r||"#444"};return{label:l,x:t-h/2,y:e-o-u,width:h,height:o+u}}function l(t,e,n){return{type:"path",x:t,y:e,path:["M",t,e,"H",n],"stroke-linecap":"butt","stroke-linejoin":"round",stroke:"#333","stroke-width":2,_translate:function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t}}}function c(t,e,n,i){var r,h,a=10,s=t>n?-1:1,o=e>i?-1:1;return Math.abs(e-i)<2*a||Math.abs(t-n)<2*a?(r=["M",t,e,"C",t+Math.min(Math.abs(n-t)/2,a)*s,e,n-(n-t)/2,i,n,i],h=function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[8]+=t,n[9]+=e}):(r=["M",t,e,"Q",t+a*s,e,t+a*s,e+a*o,"V",i-a*o,"Q",t+a*s,i,t+a*s*2,i,"H",n],h=function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[9]+=e,n[11]+=t,n[12]+=e,n[13]+=t,n[14]+=e,n[16]+=t}),{type:"path",path:r,"stroke-linecap":"butt","stroke-linejoin":"round",stroke:"#333","stroke-width":2,_translate:h}}function p(t,e,n){var i=10;return{items:[{type:"circle",fill:n,cx:t+i,cy:e,r:i,stroke:"none",_translate:function(t,e){this.cx+=t,this.cy+=e}}],width:2*i,height:2*i,x:t,y:e,lineInX:t,lineOutX:t+2*i}}function f(t){var e=[];return t.forEach(function(t){if(t.sub)e.push(d("(")),t.type===ASSERT_NODE?e.push(t.assertionType===AssertLookahead?d("?="):d("?!")):t.nonCapture&&e.push(d("?:")),e=e.concat(f(t.sub)),e.push(d(")"));else if(t.branches)t.branches.map(f).forEach(function(t){e=e.concat(t),e.push(d("|"))}),e.pop();else{var n=M[t.type]||M.defaults;switch(t.type){case EXACT_NODE:e.push(d(t.raw,n));break;case DOT_NODE:e.push(d(".",n));break;case BACKREF_NODE:e.push(d("\\"+t.num,n));break;case ASSERT_NODE:e.push(d(t.raw));break;case CHARSET_NODE:e.push(d(t.raw,M.charset))}}if(t.repeat){var i=t.repeat.min,r=t.repeat.max;0===i&&1/0===r?e.push(d("*")):1===i&&1/0===r?e.push(d("+")):0===i&&1===r?e.push(d("?")):(e.push(d("{")),e.push(d(i)),i===r?e.push(d("}")):(e.push(d(",")),isFinite(r)&&e.push(d(r)),e.push(d("}")))),t.repeat.nonGreedy&&e.push(d("?",M.repeatNonGreedy))}}),e}function d(t,e){return e=e||M[t]||M.defaults,{type:"text","font-size":m,"font-family":v,text:t+"",fill:e,"text-anchor":"start","font-weight":"bold"}}function g(t){return!t.chars&&!t.ranges.length&&1===t.classes.length}e.exportConstants();var y,m=16,w=14,x=16,v="DejaVu Sans Mono,monospace",b=10,k={},X={startPoint:function(t,e,n){return p(e,n,"r(0.5,0.5)#EFE-green")},endPoint:function(t,e,n){return p(e,n,"r(0.5,0.5)#FFF-#000")},empty:function(t,e,n){var i=6,r=l(e,n,e+i);return{items:[r],width:i,height:2,x:e,y:n,lineInX:e,lineOutX:e+i}},exact:function(t,e,n){var i="skyblue";return o(t.chars,e,n,i)},dot:function(t,e,n){var i="DarkGreen",r="white",h=o("AnyCharExceptNewLine",e,n,i,r);return h.rect.r=10,h.rect.tip="Any char except CR LF.",h},backref:function(t,e,n){var i="navy",r="white",h=o("Backref group #"+t.num,e,n,i,r);return h.rect.r=8,h},repeat:function(t,e,n){function i(t){return t+(2>t?" time.":" times.")}var r=8,h=4,s=t.repeat,o="Repeat ",l=X[t.type](t,e,n);s.min===s.max?o+=i(s.min):(o+=s.min,o+=isFinite(s.max)?(s.max-s.min>1?" to ":" or ")+i(s.max):" or more times.");var c=r,p=l.width+2*r,f=l.y+l.height+r-n,d=n,g={type:"path",path:["M",l.lineInX+r,d,"Q",e,d,e,d+c,"V",d+f-c,"Q",e,d+f,e+c,d+f,"H",e+p-c,"Q",e+p,d+f,e+p,d+f-c,"V",d+c,"Q",e+p,d,l.lineOutX+r,d],_translate:function(t,e){var n=this.path;n[1]+=t,n[2]+=e,n[4]+=t,n[5]+=e,n[6]+=t,n[7]+=e,n[9]+=e,n[11]+=t,n[12]+=e,n[13]+=t,n[14]+=e,n[16]+=t,n[18]+=t,n[19]+=e,n[20]+=t,n[21]+=e,n[23]+=e,n[25]+=t,n[26]+=e,n[27]+=t,n[28]+=e},stroke:"maroon","stroke-width":2};s.nonGreedy&&(o+="(NonGreedy!)",g.stroke="Brown",g["stroke-dasharray"]="-");var y=u(e+p/2,n,o);a([y.label],0,f+y.height+h);var m=Math.max(y.width,p),w=(m-p)/2;return w&&a([g,y.label],w,0),a(l.items,r+w,0),l.items.unshift(g),l.items.push(y.label),{items:l.items,width:m,height:l.height+r+y.height+h,x:w+r+e,y:l.y,lineInX:l.lineInX+r+w,lineOutX:l.lineOutX+r+w}},choice:function(t,e,n){var i=20,r=6,h=4,o=0,u=0,l=t.branches.map(function(t){var i=s(t,e,n);return o+=i.height,u=Math.max(u,i.width),i});o+=(l.length-1)*r+2*h,u+=2*i;var p=e+u/2,f=n-o/2+h,d=e+u,g=[];return l.forEach(function(t){var i=p-t.width/2;a(t.items,i-t.x,f-t.y);var h=c(e,n,i-t.x+t.lineInX,n+f-t.y),s=c(d,n,t.lineOutX+i-t.x,n+f-t.y);g=g.concat(t.items),g.push(h,s),f+=t.height+r}),{items:g,width:u,height:o,x:e,y:n-o/2,lineInX:e,lineOutX:d}},charset:function(t,e,n){var i=6,r=4,h={d:"Digit",D:"NonDigit",w:"Word",W:"NonWord",s:"WhiteSpace",S:"NonWhiteSpace"},s="LightSkyBlue",l="black",c="Green",p="white",f="teal",d="white",y=t.exclude?"Pink":"Khaki",m=t.exclude?"#C00":"",w=g(t);if(w){var x=o(h[t.classes[0]],e,n,c,p);if(x.rect.r=5,t.exclude){var v=u(x.x+x.width/2,x.y,"None of:",m),b=x.items;b.push(v.label);var k=x.width,X=Math.max(v.width,x.width),M=(X-k)/2;return a(b,M,0),{items:b,width:X,height:x.height+v.height,x:Math.min(v.x,x.x),y:v.y,lineInX:M+x.x,lineOutX:M+x.x+x.width}}return x}if(!t.chars&&!t.ranges.length&&!t.classes.length){var x=o("AnyChar",e,n,"green","white");return x.rect.r=5,x}var E,O,I=[],X=0,N=0;t.chars&&(E=o(t.chars,e,n,s,l),E.rect.r=5,I.push(E),X=E.width),t.ranges.forEach(function(t){t=t.split("").join("-");var i=o(t,e,n,f,d);i.rect.r=5,I.push(i),X=Math.max(i.width,X)}),t.classes.forEach(function(t){var i=o(h[t],e,n,c,p);i.rect.r=5,I.push(i),X=Math.max(i.width,X)}),O=I[0].height;var A=[],D=[];I.sort(function(t,e){return e.width-t.width}),I.forEach(function(t){2*t.width+r>X?A.push(t):D.push(t)}),I=A;for(var F,S;D.length;){if(F=D.pop(),S=D.pop(),!S){I.push(F);break}F.width-S.width>2?(I.push(F),D.push(S)):(a(S.items,F.width+r,0),I.push({items:F.items.concat(S.items),width:F.width+S.width+r,height:F.height,x:F.x,y:F.y}),N-=F.height)}X+=2*i,N=(I.length-1)*r+I.length*O+2*i;var _={type:"rect",x:e,y:n-N/2,r:4,width:X,height:N,stroke:"none",fill:y},B=_.y+i,b=[_];I.forEach(function(t){a(t.items,e-t.x+(X-t.width)/2,B-t.y),b=b.concat(t.items),B+=t.height+r});var v=u(_.x+_.width/2,_.y,(t.exclude?"None":"One")+" of:",m);b.push(v.label);var k=X;X=Math.max(v.width,X);var M=(X-k)/2;return a(b,M,0),{items:b,width:X,height:N+v.height,x:Math.min(v.x,e),y:v.y,lineInX:M+e,lineOutX:M+e+_.width}},group:function(t,e,n){var i=10,r="silver",h=2,o=s(t.sub,e,n);if(t.num){a(o.items,i,0);var l=o.width+2*i,c=o.height+2*i,p={type:"rect",x:e,y:o.y-i,r:6,width:l,height:c,"stroke-dasharray":".",stroke:r,"stroke-width":h},f=u(p.x+p.width/2,p.y-h,"Group #"+t.num),d=o.items.concat([p,f.label]),g=Math.max(f.width,l),y=(g-l)/2;return y&&a(d,y,0),{items:d,width:g,height:c+f.height,x:e,y:f.y,lineInX:y+o.lineInX+i,lineOutX:y+o.lineOutX+i}}return o},assert:function(t,e,n){var i,r={AssertNonWordBoundary:{bg:"maroon",fg:"white"},AssertWordBoundary:{bg:"purple",fg:"white"},AssertEnd:{bg:"Indigo",fg:"white"},AssertBegin:{bg:"Indigo",fg:"white"}},h=t.assertionType,s=h.replace("Assert","")+"!";if(i=r[h])return o(s,e,n,i.bg,i.fg);var l,c,p=8;h===AssertLookahead?(l="CornflowerBlue",c="darkgreen",s="If followed by:"):h===AssertNegativeLookahead&&(l="#F63",c="Purple",s="If not followed by:");var f=X.group(t,e,n),d=f.height+2*p,g=f.width+2*p,y={type:"rect",x:e,y:f.y-p,r:6,width:g,height:d,"stroke-dasharray":"-",stroke:l,"stroke-width":2},m=u(y.x+g/2,y.y,s,c),w=Math.max(g,m.width),x=(w-g)/2;a(f.items,x+p,0),x&&a([y,m.label],x,0);var v=f.items.concat([y,m.label]);return{items:v,width:w,height:y.height+m.height,x:e,y:m.y,lineInX:x+f.lineInX+p,lineOutX:x+f.lineOutX+p}}},M={exact:"#334",dot:"darkblue",backref:"teal",$:"purple","^":"purple","\\b":"#F30","\\B":"#F30","(":"blue",")":"blue","?=":"darkgreen","?!":"red","?:":"grey","[":"navy","]":"navy","|":"blue","{":"maroon",",":"maroon","}":"maroon","*":"maroon","+":"maroon","?":"maroon",repeatNonGreedy:"#F61",defaults:"black",charset:"navy"};return r});