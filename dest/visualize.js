if("function"!=typeof define)var define=require("amdefine")(module);define(["./Kit","./parse"],function(t,e){function i(t,e){if(e=e||"normal",v[t]&&v[t][e])return v[t][e];g.attr({"font-size":t,"font-weight":e});var i=g.getBBox();return v[t]=v[t]||{},v[t][e]={width:i.width/((g.attr("text").length-1)/2),height:i.height/2}}function n(t){g=g||t.text(-1e3,-1e3,"XgfTlM|.q\nXgfTlM|.q").attr("font-family",m)}function r(t,e){e.clear(),n(e);var r=i(y,"bold"),o=(r.height/2+x,0),s=0;o+=x,s=2*x,e.setSize(o,r.height+2*x);var u=h(t.tree,0,0);s=Math.max(u.height+3*x+r.height,s),o=Math.max(u.width+2*x,o),e.setSize(o,s),a(u.items,x,2*x+r.height-u.y),e.add(u.items)}function h(t,e,i){return t.unshift({type:"startPoint"}),t.push({type:"endPoint"}),o(t,e,i)}function a(t,e,i){t.forEach(function(t){t._translate&&t._translate(e,i),t.x+=e,t.y+=i})}function o(t,e,i){var n=[],r=[],h=0,a=0,o=e,s=i,u=i;if(!t.length)return X.empty(null,e,i);t.forEach(function(t){var e;e=t.repeat?X.repeat(t,o,i):X[t.type](t,o,i),n.push(e),o+=e.width+w,h+=e.width,s=Math.min(s,e.y),u=Math.max(u,e.y+e.height),r=r.concat(e.items)}),a=u-s,n.reduce(function(t,e){h+=w;var n=l(t.lineOutX,i,e.lineInX);return r.push(n),e});var c=n[0].lineInX,d=n[n.length-1].lineOutX;return{items:r,width:h,height:a,x:e,y:s,lineInX:c,lineOutX:d}}function s(e,n,r,h,a){e=t.toPrint(e);var o=6,s=i(y),u=e.length*s.width,l=s.height+2*o,c=u+2*o,d={type:"rect",x:n,y:r-l/2,width:c,height:l,stroke:"none",fill:h||"transparent"},f={type:"text",x:n+c/2,y:r,text:e,"font-size":y,fill:a||"black"};return{text:f,rect:d,items:[d,f],width:c,height:l,x:n,y:d.y,lineInX:n,lineOutX:n+c}}function u(t,e,n,r){var h,a=i(p),o=n.split("\n"),s=o.length*a.height;h=o.length>1?Math.max.apply(Math,o.map(function(t){return t.length})):n.length,h*=a.width;var u=4,l={type:"text",x:t,y:e-s/2-u,text:n,"font-size":p,fill:r||"#444"};return{label:l,x:t-h/2,y:e-s-u,width:h,height:s+u}}function l(t,e,i){return{type:"path",x:t,y:e,path:["M",t,e,"H",i],"stroke-linecap":"butt","stroke-linejoin":"round",stroke:"#333","stroke-width":2,_translate:function(t,e){var i=this.path;i[1]+=t,i[2]+=e,i[4]+=t}}}function c(t,e,i,n){var r,h,a=10,o=t>i?-1:1,s=e>n?-1:1;return Math.abs(e-n)<2*a||Math.abs(t-i)<2*a?(r=["M",t,e,"C",t+Math.min(Math.abs(i-t)/2,a)*o,e,i-(i-t)/2,n,i,n],h=function(t,e){var i=this.path;i[1]+=t,i[2]+=e,i[4]+=t,i[5]+=e,i[6]+=t,i[7]+=e,i[8]+=t,i[9]+=e}):(r=["M",t,e,"Q",t+a*o,e,t+a*o,e+a*s,"V",n-a*s,"Q",t+a*o,n,t+a*o*2,n,"H",i],h=function(t,e){var i=this.path;i[1]+=t,i[2]+=e,i[4]+=t,i[5]+=e,i[6]+=t,i[7]+=e,i[9]+=e,i[11]+=t,i[12]+=e,i[13]+=t,i[14]+=e,i[16]+=t}),{type:"path",path:r,"stroke-linecap":"butt","stroke-linejoin":"round",stroke:"#333","stroke-width":2,_translate:h}}function d(t,e,i){var n=10;return{items:[{type:"circle",fill:i,cx:t+n,cy:e,r:n,stroke:"none",_translate:function(t,e){this.cx+=t,this.cy+=e}}],width:2*n,height:2*n,x:t,y:e,lineInX:t,lineOutX:t+2*n}}function f(t){return!t.chars&&!t.ranges.length&&1===t.classes.length}e.exportConstants();var g,y=16,p=14,w=16,m="DejaVu Sans Mono,monospace",x=10,v={},X={startPoint:function(t,e,i){return d(e,i,"r(0.5,0.5)#EFE-green")},endPoint:function(t,e,i){return d(e,i,"r(0.5,0.5)#FFF-#000")},empty:function(t,e,i){var n=6,r=l(e,i,e+n);return{items:[r],width:n,height:2,x:e,y:i,lineInX:e,lineOutX:e+n}},exact:function(t,e,i){var n="skyblue";return s(t.chars,e,i,n)},dot:function(t,e,i){var n="DarkGreen",r="white",h=s("AnyCharExceptNewLine",e,i,n,r);return h.rect.r=10,h.rect.tip="Any char except CR LF.",h},backref:function(t,e,i){var n="navy",r="white",h=s("Backref group #"+t.num,e,i,n,r);return h.rect.r=8,h},repeat:function(t,e,i){function n(t){return t+(2>t?" time.":" times.")}var r=8,h=4,o=t.repeat,s="Repeat ",l=X[t.type](t,e,i);o.min===o.max?s+=n(o.min):(s+=o.min,s+=isFinite(o.max)?(o.max-o.min>1?" to ":" or ")+n(o.max):" or more times.");var c=r,d=l.width+2*r,f=l.y+l.height+r-i,g=i,y={type:"path",path:["M",l.lineInX+r,g,"Q",e,g,e,g+c,"V",g+f-c,"Q",e,g+f,e+c,g+f,"H",e+d-c,"Q",e+d,g+f,e+d,g+f-c,"V",g+c,"Q",e+d,g,l.lineOutX+r,g],_translate:function(t,e){var i=this.path;i[1]+=t,i[2]+=e,i[4]+=t,i[5]+=e,i[6]+=t,i[7]+=e,i[9]+=e,i[11]+=t,i[12]+=e,i[13]+=t,i[14]+=e,i[16]+=t,i[18]+=t,i[19]+=e,i[20]+=t,i[21]+=e,i[23]+=e,i[25]+=t,i[26]+=e,i[27]+=t,i[28]+=e},stroke:"maroon","stroke-width":2};o.nonGreedy&&(s+="(NonGreedy!)",y.stroke="Brown",y["stroke-dasharray"]="-");var p=u(e+d/2,i,s);a([p.label],0,f+p.height+h);var w=Math.max(p.width,d),m=(w-d)/2;return m&&a([y,p.label],m,0),a(l.items,r+m,0),l.items.unshift(y),l.items.push(p.label),{items:l.items,width:w,height:l.height+r+p.height+h,x:m+r+e,y:l.y,lineInX:l.lineInX+r+m,lineOutX:l.lineOutX+r+m}},choice:function(t,e,i){var n=20,r=6,h=4,s=0,u=0,l=t.branches.map(function(t){var n=o(t,e,i);return s+=n.height,u=Math.max(u,n.width),n});s+=(l.length-1)*r+2*h,u+=2*n;var d=e+u/2,f=i-s/2+h,g=e+u,y=[];return l.forEach(function(t){var n=d-t.width/2;a(t.items,n-t.x,f-t.y);var h=c(e,i,n-t.x+t.lineInX,i+f-t.y),o=c(g,i,t.lineOutX+n-t.x,i+f-t.y);y=y.concat(t.items),y.push(h,o),f+=t.height+r}),{items:y,width:u,height:s,x:e,y:i-s/2,lineInX:e,lineOutX:g}},charset:function(t,e,i){var n=6,r=4,h={d:"Digit",D:"NonDigit",w:"Word",W:"NonWord",s:"WhiteSpace",S:"NonWhiteSpace"},o="LightSkyBlue",l="black",c="Green",d="white",g="teal",y="white",p=t.exclude?"Pink":"Khaki",w=t.exclude?"#C00":"",m=f(t);if(m){var x=s(h[t.classes[0]],e,i,c,d);if(x.rect.r=5,t.exclude){var v=u(x.x+x.width/2,x.y,"None of:",w),X=x.items;X.push(v.label);var k=x.width,b=Math.max(v.width,x.width),M=(b-k)/2;return a(X,M,0),{items:X,width:b,height:x.height+v.height,x:Math.min(v.x,x.x),y:v.y,lineInX:M+x.x,lineOutX:M+x.x+x.width}}return x}if(!t.chars&&!t.ranges.length&&!t.classes.length){var x=s("AnyChar",e,i,"green","white");return x.rect.r=5,x}var I,O,E=[],b=0,A=0;t.chars&&(I=s(t.chars,e,i,o,l),I.rect.r=5,E.push(I),b=I.width),t.ranges.forEach(function(t){t=t.split("").join("-");var n=s(t,e,i,g,y);n.rect.r=5,E.push(n),b=Math.max(n.width,b)}),t.classes.forEach(function(t){var n=s(h[t],e,i,c,d);n.rect.r=5,E.push(n),b=Math.max(n.width,b)}),O=E[0].height;var B=[],N=[];E.sort(function(t,e){return e.width-t.width}),E.forEach(function(t){2*t.width+r>b?B.push(t):N.push(t)}),E=B;for(var C,F;N.length;){if(C=N.pop(),F=N.pop(),!F){E.push(C);break}C.width-F.width>2?(E.push(C),N.push(F)):(a(F.items,C.width+r,0),E.push({items:C.items.concat(F.items),width:C.width+F.width+r,height:C.height,x:C.x,y:C.y}),A-=C.height)}b+=2*n,A=(E.length-1)*r+E.length*O+2*n;var P={type:"rect",x:e,y:i-A/2,r:4,width:b,height:A,stroke:"none",fill:p},S=P.y+n,X=[P];E.forEach(function(t){a(t.items,e-t.x+(b-t.width)/2,S-t.y),X=X.concat(t.items),S+=t.height+r});var v=u(P.x+P.width/2,P.y,(t.exclude?"None":"One")+" of:",w);X.push(v.label);var k=b;b=Math.max(v.width,b);var M=(b-k)/2;return a(X,M,0),{items:X,width:b,height:A+v.height,x:Math.min(v.x,e),y:v.y,lineInX:M+e,lineOutX:M+e+P.width}},group:function(t,e,i){var n=10,r="silver",h=2,s=o(t.sub,e,i);if(t.num){a(s.items,n,0);var l=s.width+2*n,c=s.height+2*n,d={type:"rect",x:e,y:s.y-n,r:6,width:l,height:c,"stroke-dasharray":".",stroke:r,"stroke-width":h},f=u(d.x+d.width/2,d.y-h,"Group #"+t.num),g=s.items.concat([d,f.label]),y=Math.max(f.width,l),p=(y-l)/2;return p&&a(g,p,0),{items:g,width:y,height:c+f.height,x:e,y:f.y,lineInX:p+s.lineInX+n,lineOutX:p+s.lineOutX+n}}return s},assert:function(t,e,i){var n,r={AssertNonWordBoundary:{bg:"maroon",fg:"white"},AssertWordBoundary:{bg:"purple",fg:"white"},AssertEnd:{bg:"Indigo",fg:"white"},AssertBegin:{bg:"Indigo",fg:"white"}},h=t.assertionType,o=h.replace("Assert","")+"!";if(n=r[h])return s(o,e,i,n.bg,n.fg);var l,c,d=8;h===AssertLookahead?(l="CornflowerBlue",c="darkgreen",o="If followed by:"):h===AssertNegativeLookahead&&(l="#F63",c="Purple",o="If not followed by:");var f=X.group(t,e,i),g=f.height+2*d,y=f.width+2*d,p={type:"rect",x:e,y:f.y-d,r:6,width:y,height:g,"stroke-dasharray":"-",stroke:l,"stroke-width":2},w=u(p.x+y/2,p.y,o,c),m=Math.max(y,w.width),x=(m-y)/2;a(f.items,x+d,0),x&&a([p,w.label],x,0);var v=f.items.concat([p,w.label]);return{items:v,width:m,height:p.height+w.height,x:e,y:w.y,lineInX:x+f.lineInX+d,lineOutX:x+f.lineOutX+d}}};return r});